VERSION 5.00
Begin VB.Form Form1 
   BorderStyle     =   1  'Fixed Single
   Caption         =   "Malwares Organizer by PetiK - 10/09/2009"
   ClientHeight    =   5655
   ClientLeft      =   3810
   ClientTop       =   2715
   ClientWidth     =   7815
   Icon            =   "Form1.frx":0000
   LinkTopic       =   "Form1"
   MaxButton       =   0   'False
   ScaleHeight     =   5655
   ScaleWidth      =   7815
   StartUpPosition =   2  'CenterScreen
   Begin VB.Frame Frame3 
      Caption         =   "Grow up Collection"
      Height          =   1575
      Left            =   120
      TabIndex        =   12
      Top             =   3960
      Width           =   7575
      Begin VB.OptionButton opt4 
         Caption         =   "Move Files"
         Height          =   255
         Left            =   1440
         TabIndex        =   18
         Top             =   960
         Width           =   1095
      End
      Begin VB.OptionButton opt3 
         Caption         =   "Copy Files"
         Height          =   255
         Left            =   120
         TabIndex        =   17
         Top             =   960
         Value           =   -1  'True
         Width           =   1095
      End
      Begin VB.CommandButton Command5 
         Caption         =   "Go work to bracket malwares"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   495
         Left            =   2640
         TabIndex        =   16
         Top             =   840
         Width           =   3615
      End
      Begin VB.CommandButton Command4 
         Caption         =   "Browse..."
         Height          =   375
         Left            =   6360
         TabIndex        =   15
         Top             =   360
         Width           =   1095
      End
      Begin VB.TextBox collection_dest 
         Height          =   285
         Left            =   1320
         TabIndex        =   14
         Top             =   360
         Width           =   4935
      End
      Begin VB.Label Label4 
         Caption         =   "Collection Path :"
         Height          =   255
         Left            =   120
         TabIndex        =   13
         Top             =   360
         Width           =   1215
      End
   End
   Begin VB.CommandButton Command3 
      Caption         =   "Go work to create Malwares with Kaspersky's names"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   12
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   495
      Left            =   120
      TabIndex        =   10
      Top             =   3240
      Width           =   7575
   End
   Begin VB.Frame Frame2 
      Caption         =   "Destination"
      Height          =   1215
      Left            =   120
      TabIndex        =   4
      Top             =   1920
      Width           =   7575
      Begin VB.OptionButton opt1 
         Caption         =   "Copy Files"
         Height          =   255
         Left            =   1080
         TabIndex        =   9
         Top             =   840
         Value           =   -1  'True
         Width           =   1095
      End
      Begin VB.OptionButton opt2 
         Caption         =   "Move Files"
         Height          =   255
         Left            =   2280
         TabIndex        =   8
         Top             =   840
         Width           =   1335
      End
      Begin VB.CommandButton Command2 
         Caption         =   "Browse..."
         Height          =   375
         Left            =   6360
         TabIndex        =   7
         Top             =   360
         Width           =   1095
      End
      Begin VB.TextBox folder_dest 
         Height          =   285
         Left            =   1080
         TabIndex        =   6
         Top             =   360
         Width           =   5175
      End
      Begin VB.Label Label2 
         Caption         =   "Folder Path :"
         Height          =   255
         Left            =   120
         TabIndex        =   5
         Top             =   360
         Width           =   975
      End
   End
   Begin VB.Frame Frame1 
      Caption         =   "Report from Kaspersky 2009"
      Height          =   1095
      Left            =   120
      TabIndex        =   0
      Top             =   720
      Width           =   7575
      Begin VB.CommandButton Command1 
         Caption         =   "Browse..."
         Height          =   375
         Left            =   6360
         TabIndex        =   2
         Top             =   360
         Width           =   1095
      End
      Begin VB.TextBox logfile 
         Height          =   285
         Left            =   840
         TabIndex        =   1
         Top             =   360
         Width           =   5415
      End
      Begin VB.Label Label1 
         Caption         =   "File path :"
         Height          =   255
         Left            =   120
         TabIndex        =   3
         Top             =   360
         Width           =   735
      End
   End
   Begin VB.Label Label3 
      Caption         =   "Malwares Organizer with Kaspersky 2009"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   -1  'True
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H000000C0&
      Height          =   375
      Left            =   960
      TabIndex        =   11
      Top             =   120
      Width           =   5895
   End
End
Attribute VB_Name = "Form1"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Private Declare Function GetOpenFileName Lib "comdlg32.dll" Alias "GetOpenFileNameA" (pOpenfilename As OPENFILENAME) As Long
Const BIF_RETURNONLYFSDIRS = 1
Const MAX_PATH = 260
Private Declare Sub CoTaskMemFree Lib "ole32.dll" (ByVal hMem As Long)
Private Declare Function lstrcat Lib "kernel32" Alias "lstrcatA" (ByVal lpString1 As String, ByVal lpString2 As String) As Long
Private Declare Function SHBrowseForFolder Lib "shell32" (lpbi As BrowseInfo) As Long
Private Declare Function SHGetPathFromIDList Lib "shell32" (ByVal pidList As Long, ByVal lpBuffer As String) As Long
Private Declare Function CopyFile Lib "kernel32" Alias "CopyFileA" (ByVal lpExistingFileName As String, ByVal lpNewFileName As String, ByVal bFailIfExists As Long) As Long
Private Declare Function MoveFile Lib "kernel32" Alias "MoveFileA" (ByVal lpExistingFileName As String, ByVal lpNewFileName As String) As Long



Private Type BrowseInfo
    hWndOwner As Long
    pIDLRoot As Long
    pszDisplayName As Long
    lpszTitle As Long
    ulFlags As Long
    lpfnCallback As Long
    lParam As Long
    iImage As Long
End Type

Private Type OPENFILENAME
    lStructSize As Long
    hWndOwner As Long
    hInstance As Long
    lpstrFilter As String
    lpstrCustomFilter As String
    nMaxCustFilter As Long
    nFilterIndex As Long
    lpstrFile As String
    nMaxFile As Long
    lpstrFileTitle As String
    nMaxFileTitle As Long
    lpstrInitialDir As String
    lpstrTitle As String
    flags As Long
    nFileOffset As Integer
    nFileExtension As Integer
    lpstrDefExt As String
    lCustData As Long
    lpfnHook As Long
    lpTemplateName As String
End Type

Private Sub Command1_Click()
Dim OFName As OPENFILENAME
    OFName.lStructSize = Len(OFName)
    OFName.hWndOwner = Me.hWnd
    OFName.hInstance = App.hInstance
    OFName.lpstrFilter = "All Files (*.*)" + Chr$(0) + "*.*" + Chr$(0)
    OFName.lpstrFile = Space$(254)
    OFName.nMaxFile = 255
    OFName.lpstrFileTitle = Space$(254)
    OFName.nMaxFileTitle = 255
    OFName.lpstrInitialDir = App.Path
    OFName.lpstrTitle = "Kaspersky 2009 LOG File"
    OFName.flags = 0

    'Show the 'Open File'-dialog
    If GetOpenFileName(OFName) Then logfile.Text = Trim$(OFName.lpstrFile)

End Sub



Private Sub Command2_Click()
    Dim iNull As Integer, lpIDList As Long, lResult As Long
    Dim sPath As String, udtBI As BrowseInfo
    With udtBI
        'Set the owner window
        .hWndOwner = Me.hWnd
        'lstrcat appends the two strings and returns the memory address
        .lpszTitle = lstrcat("Please choose a folder to stock malwares with new names", "")
        'Return only if the user selected a directory
        .ulFlags = BIF_RETURNONLYFSDIRS
    End With

    'Show the 'Browse for folder' dialog
    lpIDList = SHBrowseForFolder(udtBI)
    If lpIDList Then
        sPath = String$(MAX_PATH, 0)
        'Get the path from the IDList
        SHGetPathFromIDList lpIDList, sPath
        'free the block of memory
        CoTaskMemFree lpIDList
        iNull = InStr(sPath, vbNullChar)
        If iNull Then
            sPath = Left$(sPath, iNull - 1)
            folder_dest.Text = sPath
        End If
    End If
End Sub


Private Sub Command3_Click()
Dim contenu As String
Dim nom_malware As String
Dim emplacement_malware As String

Dim f As Integer
f = FreeFile

If Len(Me.logfile.Text) = 0 Then
MsgBox "No Logfile", vbCritical
Exit Sub
ElseIf Len(Me.folder_dest.Text) = 0 Then
MsgBox "No Folder", vbCritical
Exit Sub
End If

Open Me.logfile.Text For Input As #f     ' Ouvre le fichier.
Do While Not EOF(f)    ' Effectue la boucle jusqu'à la fin du fichier.
    Line Input #f, contenu        ' Lit la ligne dans la variable.
    If Mid(contenu, 23, 4) = "tect" Then
    contenu = Replace(contenu, Chr(9), "*")
    MsgBox contenu
    nom_malware = ""
    emplacement_malware = ""
    i = 31
    Do While Mid(contenu, i, 1) <> "*"
    nom_malware = nom_malware & Mid(contenu, i, 1)
    'msgbox Mid(contenu, i, 1)
    i = i + 1
    Loop

    i = i + 1

    Do Until Mid(contenu, i, 1) = "*" Or Mid(contenu, i, 1) = "/"
    emplacement_malware = emplacement_malware & Mid(contenu, i, 1)
    If i > 200 Then
    MsgBox "Error : ne trouve pas le nom du fichier", vbCritical
    Exit Sub
    End If
    'msgbox Mid(contenu, i, 1)
    i = i + 1
    Loop
    
    'MsgBox emplacement_malware, vbInformation, nom_malware  ' Affiche dans la fenêtre Exécution.
    If opt1.Value = True Then ' on va copier les fichiers
    CopyFile emplacement_malware, folder_dest & "\" & nom_malware, 0
    ElseIf opt2.Value = True Then ' on va déplacer les fichiers
    MoveFile emplacement_malware, folder_dest & "\" & nom_malware
    End If
    
    End If
Loop
Close #f    ' Ferme le fichier.

MsgBox "ok", vbInformation

End Sub

Private Sub Command4_Click()
    Dim iNull As Integer, lpIDList As Long, lResult As Long
    Dim sPath As String, udtBI As BrowseInfo
    With udtBI
        'Set the owner window
        .hWndOwner = Me.hWnd
        'lstrcat appends the two strings and returns the memory address
        .lpszTitle = lstrcat("Please choose your Malwares Collection Folder", "")
        'Return only if the user selected a directory
        .ulFlags = BIF_RETURNONLYFSDIRS
    End With

    'Show the 'Browse for folder' dialog
    lpIDList = SHBrowseForFolder(udtBI)
    If lpIDList Then
        sPath = String$(MAX_PATH, 0)
        'Get the path from the IDList
        SHGetPathFromIDList lpIDList, sPath
        'free the block of memory
        CoTaskMemFree lpIDList
        iNull = InStr(sPath, vbNullChar)
        If iNull Then
            sPath = Left$(sPath, iNull - 1)
            collection_dest.Text = sPath
        End If
    End If
End Sub

Private Sub Command5_Click()
Dim i As Integer
Dim type_malware As String
Dim lang_malware As String
Set fso = CreateObject("scripting.filesystemobject")
If Len(Me.folder_dest.Text) = 0 Then
MsgBox "No Malwares Folder", vbCritical
Exit Sub
ElseIf Len(Me.collection_dest.Text) = 0 Then
MsgBox "No Collection Folder", vbCritical
Exit Sub
End If

dm = folder_dest.Text
cd = collection_dest.Text
Set dossier_malwares = fso.GetFolder(dm)
For Each fichier In dossier_malwares.Files

i = 1
type_malware = ""
lang_malware = ""

Do Until Mid(fichier.Name, i, 1) = "."
type_malware = type_malware & Mid(fichier.Name, i, 1)
i = i + 1
If i > 70 Then Exit Do
Loop

'On créée le premier dossier si n'existe pas
If Not fso.FolderExists(cd & "\" & type_malware) Then
fso.CreateFolder (cd & "\" & type_malware)
End If

i = i + 1
Do Until Mid(fichier.Name, i, 1) = "."
lang_malware = lang_malware & Mid(fichier.Name, i, 1)
i = i + 1
If i > 70 Then Exit Do
Loop

'On créée le deuxième dossier si n'existe pas
If Not fso.FolderExists(cd & "\" & type_malware & "\" & lang_malware) Then
fso.CreateFolder (cd & "\" & type_malware & "\" & lang_malware)
End If

If opt3.Value = True Then
CopyFile fichier.Path, cd & "\" & type_malware & "\" & lang_malware & "\" & fichier.Name, 0
ElseIf opt4.Value = True Then
MoveFile fichier.Path, cd & "\" & type_malware & "\" & lang_malware & "\" & fichier.Name
End If

Next

MsgBox "OK", vbInformation

End Sub
